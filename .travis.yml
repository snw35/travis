services: docker
language: bash
install:
  - env | sort
  - git clone https://github.com/docker-library/official-images.git ~/official-images
  - docker run -it --rm --name nvchecker --mount type=bind,source=${PWD},target=/data/ -w /data -e NVCHECKER_GITHUB_TOKEN=${GH_TOKEN} snw35/nvchecker:latest nvchecker nvchecker.ini
  - docker run -it --rm --name dfupdate --mount type=bind,source=${PWD},target=/data/ -w /data snw35/dfupdate:latest
  - if [[ $(git status --porcelain | wc -l) -eq 0 ]] && [[ -z ${TRAVIS_TAG} ]]; then
      echo "No local changes detected and no tag set, nothing to build, exiting.";
      travis_terminate 0;
    else
      echo "Local changes or tagged commit detected, continuing...";
    fi

before_script:
  - TRAVIS_VERSION=`grep "ENV TRAVIS_VERSION" Dockerfile | cut -d " " -f 3 | head -n 1`
  - BASE_VERSION=`grep "FROM" Dockerfile | cut -d " " -f 2 | cut -d ":" -f 2`
  - IMAGE="${TRAVIS_REPO_SLUG}:${TRAVIS_VERSION}"
  - PROPOSED_TAG=${TRAVIS_VERSION}-${BASE_VERSION}
  - git config --local user.name "${DOCKER_USERNAME}"
  - git config --local user.email "snw35@use.startmail.com"
  - git remote add upstream https://${GH_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git > /dev/null 2>&1
  - if [ $(git ls-remote --tags upstream "${PROPOSED_TAG}" | wc -l) -eq 0 ]; then
      echo "Propsoed tag does not exist on remote, continuing.";
    else
      echo "Proposed tag already exists on remote, skipping container build.";
      travis_terminate 0;
    fi

script:
  - env | sort
  - travis_retry docker build -t "$IMAGE" .
  - ~/official-images/test/run.sh "$IMAGE" || travis_terminate 1;
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker push "$IMAGE"
  - docker tag "$IMAGE" "${TRAVIS_REPO_SLUG}:latest"
  - docker push "${TRAVIS_REPO_SLUG}:latest"

after_script:
  - docker images

before_deploy:
  - cp new_ver.txt old_ver.txt
  - git checkout master
  - git add -A
  - git commit --message "Software Updated"
  - git tag $PROPOSED_TAG
  - git push --quiet --set-upstream upstream
  - git push --tags --quiet --set-upstream upstream

deploy:
  provider: releases
  api_key: "$GH_TOKEN"
  skip_cleanup: true
  body: 'base image version: $BASE_VERSION
    travis version: $TRAVIS_VERSION
    image deployed: $IMAGE'

branches:
  except:
  - "/^untagged/"

env:
  global:
  - secure: MCI0b6D4v4BW5te70PdAknqDPAdiMQO0VO+HfZGD4SAq4BUtgueCVP9zfXeGjwCOQZLkE5gLoZ+8oNsN9oedKrg/GHW3RyHipezTS76Zu8TkijQnk6Xlsu66haILDcV/hMQhYV+CEeQmu/FqzpMRzqAAd8YSUSmHuRiD79ZARN6+6Yd9jeJGGoo5Sa6uNzgjGdX4ub/R/EvU+q1/3werEJs0Qz7zET1iwJvf8sbtH7DD466CxK8lZyB+6X1Ws0cCOOsZpMOSD60io6PNi4ksQhQNFbr589l7FBZhRuplCUb5mVnpUL5ko+4sRGWM+wCdbYNDS49UgzqUcj9O8SbXFS7oSoKBq/8mTnNlMxovMklCsWsWQgt1X1wGcuTbKV9ISmUaHXVRHyQ1rB7rf6rXPLTlbMLxJrExIjMa2PsLf8JXfHpTmIrUeQK+KfFDQePS60Vvb4qEuZEBgehSeFXKZjj/YHD2g8z7yWNOAqx8VxrgwPinSL2GXamgWGfDVPYq6LF8fvumor/POeqMf5wQqTq2gQk6eQ3s6BZ1CkA6B56TmPqlKmXF+Jklhgddwu3zDHrkPIdUw8SSGkvuMOmxeq2aLvKxqpf/Y4iG1jGPRW/nUnrYHZBGD2oQM47R4OUbjiTg+LqW2eSbPUVpBL7iF3Frxn1ZdiGRVBqvXEirzVo=
  - secure: 0fa6Ch9BtrhoRUSqb9HbZLoBRRg2y72CUq7dwsY5FPITaDVCpw2El++160HTb/YuR0mOjoyT2/IF7d5GtVNroKjIUNoZ2fLGmwN6yp0056qflsPnK7ij1a+ab8Bb0qSMVNZ82rZstOL8E9d61dXgXa6SmbOk5xxa0N6vZfGBoGirGtVo7WkAa6aWAnJ2e3oaU1b3PWmSR3CEi7QaYySiulVfXF3a9aHMN1X3KN6E+7irh+KS9Qvi1EVr5pQJQItO8BSRL2+Ze1j4npVMn+nXosX5EgAm3K205z8MIFR83yBujcCy+gUsSlD79GXV5Gc1sw7JCNiP0IxoSsrJ0rmPwom9YxQUDHAOGtg6Z/NWFq2210wiRGz1KuGNyILc83kzCCDXlgB6Lx5Ek+4TNRSJNeN37orodc3zO5s/e+EOVW75t23WvhM6exNkA3/dn9yQJ45pLFkkYZ2uRP8Rp8VinIubOsngeeHLUzo0BZ808e6VOmue04rryYexyTdMEZkma4u5ZLlRtSRWZQ55q8AofFfRxsgeB3f5QYTMKV8zIU3rOfe4GkmEyHhr+GiDiDRPUuuv1zdvXeJxNaqT1MhPPTNkNTK+I91EsnmjNiiJtv/rroDEx0pVI+o9NFKw4VzoSEun+llFqz0knCxbRz6L4w3FIQlwZJT0vEziLSZuOFE=
  - secure: IaScGCcKfbkSogkJuK/OoZ963MtDFVLFy0Kh2vkdDbYRd7BXLKPwJkX6XE4rBhPA0daEJ9xuqOSKjfhjxkNkkzPhtR569VfI25XTWp1Uu/Yf1icGty+rQDoBHz6AhBvQ/NKCsrfITsslXw59BjB/eRGl0d4HZVhct2nFBKsuHOIompBiP7zuGPs/OLGNiJGnVxd5/w1yS6A0SYEVGFdhc1fDch24mALJ/SYzi9CIIF48DBFPdiEJNnKXLQbXraj6+ezfYDzcqToJugIOngnhxp9XFvRAcQs1FkDSTTBDvlKXPMcMIi7Ry9Tp9SgkLt/ylZbF8oUoqKvYaTD772n6iIHlIbfJKZp/iAcmE4oumSkNZ/KMiU/nt6hBxCCDZWH61vopMjyDsUct4qUC4v++pHyfhGS71QL3xWbXp61teEIflZiK/quuALSBb/nfua39D8uck6O1S9G1LUWzP56Two6iQwnNriIk8p3WkizoDpuzAoJjuyiEfHUEu/SF9Bk6Zu/5DQrf71PEVxRHuQNeWtN9xs/vKgNmkgIAB3OFyNHMs3aep0i4zsu/MUcR8hpGxDF1LwPNHxqilbW5j9LxkHdvxNlptBuwLgyT8ZnrixXP80B/0uDym44cu00GJUu3yXlcO7z4B7jEqzguUCGHHkEQxfInmL9rSFGVPrnTJ8Q=
